services:
  postgres:
    image: postgres:16-alpine
    container_name: greenscape-prod-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: receptionist
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    volumes:
      - receptionist_pg_prod_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d receptionist"]
      interval: 10s
      timeout: 5s
      retries: 10

  backend:
    build:
      context: ./backend
    container_name: greenscape-prod-backend
    restart: unless-stopped
    command: sh -c "node src/init-db.js && npm start"
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      PORT: 5000
      CORS_ORIGIN: http://localhost:8080
      PGHOST: postgres
      PGPORT: 5432
      PGUSER: postgres
      PGPASSWORD: postgres
      PGDATABASE: receptionist
      PGSSL: "false"
      BACKEND_API_KEY: ${BACKEND_API_KEY:-change_this_key}
      RATE_LIMIT_WINDOW_MS: 60000
      RATE_LIMIT_MAX: 300
      RETENTION_DAYS: ${RETENTION_DAYS:-180}
      BACKUP_DIR: /app/backups
    volumes:
      - receptionist_backups:/app/backups
    healthcheck:
      test: ["CMD-SHELL", "wget -q -O - http://localhost:5000/api/health/ready || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 8

  frontend:
    build:
      context: ./receptionist-react
      args:
        REACT_APP_RECEPTIONIST_API_URL: /api
        REACT_APP_RECEPTIONIST_API_KEY: ${BACKEND_API_KEY:-change_this_key}
        REACT_APP_KIOSK_ID: ${REACT_APP_KIOSK_ID:-greenscape-lobby-kiosk-1}
        REACT_APP_GEMINI_API_KEY: ${REACT_APP_GEMINI_API_KEY:-}
    container_name: greenscape-prod-frontend
    restart: unless-stopped
    depends_on:
      backend:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget -q -O - http://localhost/ || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 8

  edge:
    image: nginx:1.27-alpine
    container_name: greenscape-prod-edge
    restart: unless-stopped
    depends_on:
      frontend:
        condition: service_healthy
      backend:
        condition: service_healthy
    ports:
      - "8080:80"
    volumes:
      - ./deploy/edge.nginx.conf:/etc/nginx/nginx.conf:ro
    healthcheck:
      test: ["CMD-SHELL", "wget -q -O - http://localhost/api/health/live || exit 1"]
      interval: 20s
      timeout: 5s
      retries: 8

volumes:
  receptionist_pg_prod_data:
  receptionist_backups:
